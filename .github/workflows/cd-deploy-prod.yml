name: CD / Deploy Production

on:
  push:
    branches: [master]
    paths:
      - "backend/**"
      - "frontend/**"
      - "docker-compose.yml"
      - ".github/workflows/**"

concurrency:
  group: cd-prod
  cancel-in-progress: true

jobs:
  deploy:
    name: Production / Build + Deploy
    runs-on: [self-hosted, Linux]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy backend env from VM to workspace
        run: |
          cp /home/bc/PIMS/backend/.env ./backend/.env
          ls -la ./backend/.env


      - name: Build images
        run: |
          docker build -t pims-backend:latest ./backend
          docker build -t pims-frontend:latest ./frontend

      - name: Deploy with compose
        run: |
          docker compose up -d
          docker image prune -f
